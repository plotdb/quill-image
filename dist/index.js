// Generated by LiveScript 1.6.0
var Embed, Delta, fit2size, attrname, getfmt, setfmt, imagePlusBlot, resizer, ref$;
Embed = Quill['import']('blots/embed');
Delta = Quill['import']('delta');
fit2size = function(v){
  v == null && (v = '');
  if (!v || v === 'fill') {
    return "100% 100%";
  } else {
    return v;
  }
};
attrname = function(v){
  if (v === 'width' || v === 'height') {
    return v;
  } else if (v === 'key') {
    return "data-qip-" + v;
  } else {
    return "data-" + v;
  }
};
getfmt = function(arg$){
  var node, name, s, v;
  node = arg$.node, name = arg$.name;
  if (name === 'width' || name === 'height' || name === 'mode') {
    return node.getAttribute(attrname(name)) || '';
  }
  s = node.style;
  if (name === 'fit') {
    return (v = s.backgroundSize) === "100% 100%" || !v ? "fill" : v;
  }
  if (name === 'repeat') {
    return s.backgroundRepeat || 'repeat';
  }
};
setfmt = function(arg$){
  var node, n, v;
  node = arg$.node, n = arg$.name, v = arg$.value;
  if (n === 'mode' && !v) {
    v = {
      mode: 'free'
    }[n];
  }
  if (n === 'width' || n === 'height' || n === 'mode') {
    if (v != null) {
      return node.setAttribute(attrname(n), v);
    } else {
      return node.removeAttribute(attrname(n));
    }
  } else if (n === 'fit') {
    return node.style.backgroundSize = fit2size(v);
  } else if (n === 'repeat') {
    return node.style.backgroundRepeat = v || 'no-repeat';
  } else {
    return Embed.call(this, n, v);
  }
};
imagePlusBlot = function(){
  return Reflect.construct(Embed, arguments, imagePlusBlot);
};
imagePlusBlot.prototype = Object.create(Embed.prototype);
imagePlusBlot.prototype.constructor = imagePlusBlot;
imagePlusBlot.prototype.format = function(n, v){
  return setfmt({
    node: this.domNode,
    name: n,
    value: v
  });
};
Object.setPrototypeOf(imagePlusBlot, Embed);
resizer = function(){
  var n, moveHandler, this$ = this;
  this._ = {
    dom: {}
  };
  this._.dom.caret = document.createElement('div');
  this._.dom.caret.classList.add('quill-image-plus-resizer-caret');
  this._.dom.base = document.createElement('div');
  this._.dom.base.classList.add('quill-image-plus-resizer-root');
  import$(this._.dom, Object.fromEntries(['n', 'e', 's', 'w'].map(function(t){
    var n;
    n = document.createElement('div');
    this$._.dom.base.appendChild(n);
    n.classList.add('quill-image-plus-resizer-bar', "quill-image-plus-resizer-bar-" + (t === 'n' || t === 's' ? 'horizontal' : 'vertical'));
    return [t, n];
  })));
  import$(this._.dom, Object.fromEntries(['nw', 'ne', 'se', 'sw'].map(function(t){
    var n;
    n = document.createElement('div');
    this$._.dom.base.appendChild(n);
    n.classList.add('quill-image-plus-resizer-dot');
    return [t, n];
  })));
  this._.dom.button = n = document.createElement('div');
  this._.dom.base.appendChild(n);
  n.classList.add('quill-image-plus-button');
  this._.dom.button.innerHTML = "<div data-action=\"src\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"12px\" viewBox=\"0 0 1200 1200\"><path d=\"M1099.8 345.4v-.4a49.8 49.8 0 0 0-9.4-24.6c-.1 0-.2 0-.2-.2l-1.2-1.5-.4-.4-1.2-1.4-.4-.5a50 50 0 0 0-1.6-1.8l-300-300-1.8-1.6-.5-.4-1.4-1.2-.4-.4-1.5-1.2c-.1 0-.2 0-.3-.2l-1.8-1.2A49.7 49.7 0 0 0 755 .2h-.4A50.3 50.3 0 0 0 750 0H150a50 50 0 0 0-50 50v1100a50 50 0 0 0 50 50h900a50 50 0 0 0 50-50V350a49.7 49.7 0 0 0-.2-4.6zM800 170.7 929.3 300H800V170.7zM200 1100V100h500v250a50 50 0 0 0 50 50h250v700H200z\"/></svg></div>\n<div data-action=\"fit\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"12px\" viewBox=\"0 0 1200 1200\"><path d=\"M1100 50H100a50 50 0 0 0-50 50v1000a50 50 0 0 0 50 50h1000a50 50 0 0 0 50-50V100a50 50 0 0 0-50-50zm-50 1000H150V150h900v900zM350 900h500a50 50 0 0 0 50-50V350a50 50 0 0 0-50-50H350a50 50 0 0 0-50 50v500a50 50 0 0 0 50 50zm50-500h400v400H400V400z\"/></svg></div>";
  this._.dom.button.addEventListener('mousedown', function(evt){
    return evt.stopPropagation();
  });
  this._.dom.button.addEventListener('mouseup', function(evt){
    return evt.stopPropagation();
  });
  this._.dom.button.addEventListener('click', function(evt){
    var tgt, action, blot, quill, index, f, cur, cycle, i, next, ref$;
    evt.stopPropagation();
    if (!(tgt = evt.target.closest('.quill-image-plus-button > div[data-action]'))) {
      return;
    }
    action = tgt.dataset.action;
    switch (action) {
    case 'src':
      break;
    case 'fit':
      if (!(blot = Quill.find(this$._.tgt.node))) {
        return;
      }
      quill = this$._.editor;
      index = quill.getIndex(blot);
      f = quill.getFormat(index, 1);
      cur = f.fit || 'fill';
      cycle = ['fill', 'cover', 'contain'];
      i = cycle.indexOf(cur);
      next = cycle[(i + 1) % cycle.length];
      quill.formatText(index, 1, {
        fit: next
      });
      return this$.bind({
        node: (ref$ = this$._.tgt).node,
        key: ref$.key
      });
    }
  });
  moveHandler = function(evt){
    var n, ref$, blot, index, ref1$, ref2$, x, y, dir, free, dx, dy, w, h, width, height;
    evt.stopPropagation();
    if (!this$._.start || !evt.buttons) {
      window.removeEventListener('mousemove', moveHandler);
      window.removeEventListener('mouseup', moveHandler);
      document.body.classList.toggle('quill-image-plus-select-suppress', false);
      if (!this$._.previewPos) {
        return;
      }
      n = this$._.editor.container.querySelector("[data-qip-key='" + ((ref$ = this$._.tgt) != null ? ref$.key : void 8) + "']");
      blot = Quill.find(n);
      index = this$._.editor.getIndex(blot);
      this$._.editor.formatText(index, 1, {
        width: (ref1$ = this$._.previewPos).width,
        height: ref1$.height
      });
      return this$.bind({
        node: n,
        key: (ref1$ = this$._.tgt) != null ? ref1$.key : void 8
      });
    }
    ref2$ = [evt.clientX, evt.clientY, this$._.dir, evt.altKey], x = ref2$[0], y = ref2$[1], dir = ref2$[2], free = ref2$[3];
    ref2$ = [x - this$._.x, y - this$._.y], dx = ref2$[0], dy = ref2$[1];
    ref2$ = [this$._.pos.width, this$._.pos.height], w = ref2$[0], h = ref2$[1];
    if (/n/.exec(dir)) {
      dy = -dy;
    }
    if (/w/.exec(dir)) {
      dx = -dx;
    }
    if (!free) {
      if (!this$._.resizeBasedAxis) {
        this$._.resizeBasedAxis = Math.abs(dx) > Math.abs(dy) ? 'x' : 'y';
      }
      ref2$ = this$._.resizeBasedAxis === 'x'
        ? [dx, dx * h / w]
        : [dy * w / h, dy], dx = ref2$[0], dy = ref2$[1];
    }
    ref2$ = this$._.pos, x = ref2$.x, y = ref2$.y, width = ref2$.width, height = ref2$.height;
    if (/n/.exec(dir)) {
      ref2$ = [this$._.pos.y - dy, this$._.pos.height + dy], y = ref2$[0], height = ref2$[1];
    }
    if (/s/.exec(dir)) {
      ref2$ = [this$._.pos.y, this$._.pos.height + dy], y = ref2$[0], height = ref2$[1];
    }
    if (/w/.exec(dir)) {
      ref2$ = [this$._.pos.x - dx, this$._.pos.width + dx], x = ref2$[0], width = ref2$[1];
    }
    if (/e/.exec(dir)) {
      ref2$ = [this$._.pos.x, this$._.pos.width + dx], x = ref2$[0], width = ref2$[1];
    }
    return this$.repos({
      x: x,
      y: y,
      width: width,
      height: height,
      preview: true,
      mode: getfmt({
        node: (ref2$ = this$._.tgt) != null ? ref2$.node : void 8,
        name: 'mode'
      })
    });
  };
  this._.dom.base.addEventListener('mousedown', function(evt){
    var dir, ref$;
    dir = ['nw', 'ne', 'se', 'sw', 'n', 's', 'w', 'e'].filter(function(t){
      return this$._.dom[t] === evt.target;
    })[0];
    if (!dir) {
      return;
    }
    this$._.start = true;
    ref$ = this$._;
    ref$.x = evt.clientX;
    ref$.y = evt.clientY;
    ref$.dir = dir;
    ref$.resizeBasedAxis = null;
    document.body.classList.toggle('quill-image-plus-select-suppress', true);
    window.addEventListener('mousemove', moveHandler);
    return window.addEventListener('mouseup', moveHandler);
  });
  return this;
};
resizer.prototype = (ref$ = Object.create(Object.prototype), ref$.dismissCaret = function(){
  if (this._.dom.caret.parentNode) {
    return this._.dom.caret.parentNode.removeChild(this._.dom.caret);
  }
}, ref$.caret = function(arg$){
  var node, evt, ref$, x, y, container, position, range, box, rbox;
  node = arg$.node, evt = arg$.evt;
  ref$ = [evt.clientX, evt.clientY], x = ref$[0], y = ref$[1];
  container = node.closest('.ql-container');
  if (!(position = document.caretPositionFromPoint(x, y))) {
    return;
  }
  if (this._.dom.caret.parentNode) {
    this._.dom.caret.parentNode.removeChild(this._.dom.caret);
  }
  container.appendChild(this._.dom.caret);
  range = document.createRange();
  range.setStart(position.offsetNode, position.offset);
  range.setEnd(position.offsetNode, position.offset);
  box = range.getBoundingClientRect();
  rbox = container.getBoundingClientRect();
  ref$ = [box.x - rbox.x, box.y - rbox.y], x = ref$[0], y = ref$[1];
  return ref$ = this._.dom.caret.style, ref$.left = x + "px", ref$.top = y + "px", ref$;
}, ref$.unbind = function(){
  return this._.dom.base.style.display = 'none';
}, ref$.bind = function(arg$){
  var node, key, evt, container, quill, rbox, box, ref$, x, y, width, height, this$ = this;
  node = arg$.node, key = arg$.key, evt = arg$.evt;
  this._.dom.base.style.display = 'block';
  this._.tgt = {
    key: key,
    node: node
  };
  if (evt && !this._.editor) {
    container = evt.target.closest('.ql-container');
    this._.editor = quill = Quill.find(evt.target.closest('.ql-editor').parentElement);
    this._.editor.on('text-change', function(){
      return this$.unbind();
    });
  } else {
    quill = this._.editor;
    container = quill.container;
  }
  if (this._.dom.base.parentNode) {
    this._.dom.base.parentNode.removeChild(this._.dom.base);
  }
  container.appendChild(this._.dom.base);
  rbox = container.getBoundingClientRect();
  box = node.getBoundingClientRect();
  ref$ = [box.x - rbox.x, box.y - rbox.y, box.width, box.height], x = ref$[0], y = ref$[1], width = ref$[2], height = ref$[3];
  return this.repos({
    x: x,
    y: y,
    width: width,
    height: height,
    mode: getfmt({
      node: node,
      name: 'mode'
    })
  });
}, ref$.repos = function(arg$){
  var x, y, width, height, preview, mode, ref$, ref1$, nodeSize, barSize, this$ = this;
  x = arg$.x, y = arg$.y, width = arg$.width, height = arg$.height, preview = arg$.preview, mode = (ref$ = arg$.mode) != null ? ref$ : 'free';
  if (width < 0) {
    ref$ = [x + width, -width], x = ref$[0], width = ref$[1];
  }
  if (height < 0) {
    ref$ = [y + height, -height], y = ref$[0], height = ref$[1];
  }
  if (!preview) {
    ref$ = (ref1$ = this._).pos || (ref1$.pos = {});
    ref$.x = x;
    ref$.y = y;
    ref$.width = width;
    ref$.height = height;
  } else {
    ref$ = (ref1$ = this._).previewPos || (ref1$.previewPos = {});
    ref$.x = x;
    ref$.y = y;
    ref$.width = width;
    ref$.height = height;
  }
  nodeSize = 8;
  barSize = 1;
  width = Math.floor(width);
  height = Math.floor(height);
  [['nw', x, y], ['ne', x + width - nodeSize, y], ['se', x + width - nodeSize, y + height - nodeSize], ['sw', x, y + height - nodeSize]].map(function(arg$){
    var t, x, y, ref$;
    t = arg$[0], x = arg$[1], y = arg$[2];
    return ref$ = this$._.dom[t].style, ref$.transform = "translate(" + Math.floor(x) + "px, " + Math.floor(y) + "px)", ref$.display = mode !== 'auto' ? 'block' : 'none', ref$;
  });
  [['n', x, y, width, 0], ['e', x + width - barSize, y, 0, height], ['s', x, y + height - barSize, width, 0], ['w', x, y, 0, height]].map(function(arg$){
    var t, x, y, width, height, ref$;
    t = arg$[0], x = arg$[1], y = arg$[2], width = arg$[3], height = arg$[4];
    return ref$ = this$._.dom[t].style, ref$.transform = "translate(" + Math.floor(x) + "px, " + Math.floor(y) + "px)", ref$.width = (Math.floor(width) || barSize) + "px", ref$.height = (Math.floor(height) || barSize) + "px", ref$.display = mode !== 'auto' ? 'block' : 'none', ref$;
  });
  return ref$ = this._.dom.button.style, ref$.transform = "translate(" + Math.floor(x + nodeSize) + "px, " + Math.floor(y + nodeSize) + "px)", ref$;
}, ref$);
ref$ = import$(imagePlusBlot, Embed);
ref$.blotName = 'image-plus';
ref$.tagName = 'img';
ref$.create = function(opt){
  var node, lc, ref$, key;
  opt == null && (opt = {});
  if (!imagePlusBlot.resizer) {
    imagePlusBlot.resizer = new resizer();
  }
  node = Embed.create.call(this, opt);
  node._ = lc = {
    opt: {}
  };
  node.setAttribute('src', "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=");
  node.setAttribute(attrname('src'), opt.src);
  ref$ = node.style;
  ref$.background = "url(" + opt.src + ")";
  ref$.backgroundColor = 'rgba(0,0,0,.8)';
  ref$.backgroundPosition = 'center center';
  setfmt({
    node: node,
    name: 'fit',
    value: opt.fit
  });
  setfmt({
    node: node,
    name: 'repeat',
    value: opt.repeat
  });
  setfmt({
    node: node,
    name: 'mode',
    value: opt.mode
  });
  node.setAttribute('alt', opt.alt || '');
  node.setAttribute('data-qip-key', key = opt.key || "quill-image-plus-" + Math.random().toString(36).substring(2));
  lc.img = {
    ref: null,
    loading: true,
    auto: !(opt.width && opt.height)
  };
  lc.promise = new Promise(function(res, rej){
    var img;
    lc.img.ref = img = new Image();
    img.onload = function(){
      var ref$;
      lc.img.loading = false;
      ref$ = lc.img;
      ref$.width = img.naturalWidth;
      ref$.height = img.naturalHeight;
      if (lc.img.auto) {
        setfmt({
          node: node,
          name: 'width',
          value: lc.img.width
        });
        return setfmt({
          node: node,
          name: 'height',
          value: lc.img.height
        });
      }
    };
    img.onerror = function(){
      return lc.img.loading = false;
    };
    return img.src = opt.src;
  });
  if (!opt.width) {
    opt.width = 200;
  }
  if (!opt.height) {
    opt.height = 200;
  }
  if (opt.width) {
    node.setAttribute('width', opt.width);
  }
  if (opt.height) {
    node.setAttribute('height', opt.height);
  }
  if (opt.width) {
    setfmt({
      node: node,
      name: 'width',
      value: opt.width
    });
  }
  if (opt.width) {
    setfmt({
      node: node,
      name: 'height',
      value: opt.height
    });
  }
  window.addEventListener('mouseup', function(){
    return imagePlusBlot.resizer.unbind();
  });
  node.setAttribute('draggable', false);
  node.addEventListener('mouseup', function(evt){
    return evt.stopPropagation();
  });
  node.addEventListener('mousedown', function(evt){
    var moveHandler;
    imagePlusBlot.resizer.bind({
      node: node,
      key: key,
      evt: evt
    });
    moveHandler = function(evt){
      var position, box, quill, oldBlot, oldIndex, getBlot, ref$, newBlot, newIndex, width, height, delta;
      if (evt.buttons) {
        node._.dragging = true;
        return imagePlusBlot.resizer.caret({
          node: node,
          evt: evt
        });
      }
      window.removeEventListener('mousemove', moveHandler);
      window.removeEventListener('mouseup', moveHandler);
      if (!node._.dragging) {
        return;
      }
      node._.dragging = false;
      if (!(position = document.caretPositionFromPoint(evt.clientX, evt.clientY))) {
        return;
      }
      box = node.getBoundingClientRect();
      if (!node.closest('.ql-editor')) {
        return;
      }
      quill = Quill.find(node.closest('.ql-editor').parentElement);
      oldBlot = Quill.find(node);
      oldIndex = quill.getIndex(oldBlot);
      getBlot = function(arg$){
        var n, idx, ref$, blot, index;
        n = arg$.offsetNode, idx = arg$.offset;
        if (n.nodeName !== '#text' && n.childNodes != null) {
          ref$ = [n.childNodes[idx < (ref$ = n.childNodes - 1) ? idx : ref$], 0], n = ref$[0], idx = ref$[1];
        }
        blot = Quill.find(n, true);
        index = !blot
          ? 0
          : quill.getIndex(blot) + idx;
        return {
          blot: blot,
          index: index
        };
      };
      ref$ = getBlot(position), newBlot = ref$.blot, newIndex = ref$.index;
      if (!newBlot) {
        return;
      }
      ref$ = oldBlot.formats(), width = ref$.width, height = ref$.height;
      if (newIndex > oldIndex) {
        newIndex -= 1;
      }
      if (newIndex === oldIndex) {
        return;
      }
      delta = new Delta().retain(oldIndex < newIndex ? oldIndex : newIndex);
      delta = oldIndex < newIndex
        ? delta['delete'](1)
        : oldIndex > newIndex ? delta.insert({
          'image-plus': import$((ref$ = {
            alt: node.alt,
            width: node.width,
            height: node.height
          }, ref$.transient = true, ref$), Object.fromEntries(['src', 'key'].map(function(t){
            return [t, node.getAttribute(attrname(t))];
          })))
        }, {
          width: width,
          height: height
        }) : delta;
      delta = delta.retain(Math.abs(newIndex - oldIndex));
      delta = oldIndex > newIndex
        ? delta['delete'](1)
        : oldIndex < newIndex ? delta.insert({
          'image-plus': import$((ref$ = {
            alt: node.alt,
            width: node.width,
            height: node.height
          }, ref$.transient = true, ref$), Object.fromEntries(['src', 'key'].map(function(t){
            return [t, node.getAttribute(attrname(t))];
          })))
        }, {
          width: width,
          height: height
        }) : delta;
      quill.updateContents(delta);
      return imagePlusBlot.resizer.dismissCaret();
    };
    window.addEventListener('mousemove', moveHandler);
    return window.addEventListener('mouseup', moveHandler);
  });
  if (opt.transient) {
    node.onload = function(){
      return imagePlusBlot.resizer.bind({
        node: node,
        key: key
      });
    };
  }
  return node;
};
ref$.value = function(n){
  return Object.fromEntries(['src', 'alt', 'key'].map(function(t){
    return [t, n.getAttribute(attrname(t))];
  }));
};
ref$.formats = function(node){
  return Object.fromEntries(['width', 'height', 'mode', 'fit', 'repeat'].map(function(name){
    return [
      name, getfmt({
        node: node,
        name: name
      })
    ];
  }));
};
Quill.register(imagePlusBlot);
function import$(obj, src){
  var own = {}.hasOwnProperty;
  for (var key in src) if (own.call(src, key)) obj[key] = src[key];
  return obj;
}
